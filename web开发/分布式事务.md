#分布式事务
## 传统分布式事务
![[传统分布式事务-成功.png]]
![[传统分布式事务-失败.png]]
传统的分布事务使用2pc，这套方案依赖于底层数据库的支持，DB这层首先得要实现XA协议。比如MySQL InnoDB就是支持XA协议的数据库方案，可以把XA理解为一个**强一致的中心化原子提交协议**。
如上图所示，可以知道这个分布式事务有两个主要阶段，第一阶段为准备阶段，第二阶段为提交/回滚阶段，这两步的协调由一个中心化的coordinator来实现，保证事务原子性(Atomicity)
**第一步（Prepare）**：Coordinator向各个分布式事务的参与者下达Prepare指令，各个事务分别将SQL语句在数据库执行但不提交，并且将准备就绪状态上报给Coordinator。
**第二步（Commit/Rollback）**：如果所有节点都已就绪，那么Coordinator就下达Commit指令，各参与者提交本地事务，如果有任何一个节点不能就绪，Coordinator则下达Rollback指令进行本地回滚。
接下来，我们只讨论回滚的情况，在第一步的时候，任何异步出现错误或者超时的话，那么Coordinator就会对两个服务发出回滚请求，两个服务就回滚到没有执行事务的时候。
如果准备阶段成功，进入提交阶段，这个时候整个分布式事务就**只能成功，不能失败**。如果发生网络传输失败的情况，需要反复重试，直到提交成功为止，如果这个阶段发生宕机，包括两个数据库宕机或者订单服务、商品服务宕机，还是可能出现订单库完成了提交，但商品库因为宕机自动回滚，导致数据不一致的情况，但是，因为提交的过程非常简单，执行非常迅速，出现这种情况的概率比较低，所以，从实用的角度来说，2PC这种分布式事务方法，实际的数据一致性还是非常好的。
但是这种情况在高并发情况下，就会占用数据库的连接资源直到二阶段结束才会释放。
**因此这种策略适合在一般在并发量不是很大，一致性要求较高的场景**
### 分布式事务框架(DTM)
![[DTM分布式事务.png]]
DTM基于TCC来实现分布式事务
