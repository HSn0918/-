#kubernetes
# kubernetes
## [[Google Borg]]
|                                           Workload                                           | Cell                                                                                                                                                                      |                                                           Job 和 Task                                                           |                                                           Naming                                                            |
|:--------------------------------------------------------------------------------------------:| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |:-------------------------------------------------------------------------------------------------------------------------------:|:---------------------------------------------------------------------------------------------------------------------------:|
| prod:在线任务，长期运行、对延时敏感、面向终端用户等，比如GmailGoogle Docs,WebSearch 服务等。 | 一个 Cell 上跑一个集群管理系统 Borg。                                                                                                                                     | 用户以 Job 的形式提交应用部署请求。一个 Job 包含一个或多个相同的 Task，每个Task 运行相同的应用程序，Task 数量就是应用的副本数。 |                                      Borg的服务发现通过BNS（Borg Name Service）来实现                                       |
|            non-prod:离线任务，也称为批处理任务(Batch)，比如一些分布式计算服务等。            | 通过定义 Cell 可以让Borg 对服务器资源进行统一抽象，作为用户就无需知道自己的应用跑 在 哪台机器上，也不用关心资源分配、程序安装、依佢甲憐轺圆鎧骗管理、健康检查故障恢复等。 |                                  每个 Job 可以定义属性、元信息和优先级，涉及到抢占式调度过程。                                  | 50.jfoo.ubar.cc.borggoogle.com 可表示在一个名为 cc 的 Cell中由用户 uBar 部署的鐨辖滾蔁性个名为 jFoo 的 Job下的第50个 Task。 |
## 什么是kubernetes
Kubernetes 是谷歌开源的容器集群管理系统，是 Google 多年大规模容器管理技术 Borg 的开源版本，主要功能包括:
- 基于容器的应用部署、维护和滚动升级;
- 负载均衡和服务发现;
- 跨机器和跨地区的集群调度;
- 自动伸缩;
- 无状态服务和有状态服务;
- 插件机制保证扩展性。

![[kubernetes架构.excalidraw|1000*900]]
![[Kubernetes架构具体.png|750*]]

![[Kubernetes 集群.png]]
## Kubernetes:声明式系统
Kubernetes 的所有管理能力构建在对象抽象的基础上，核心对象包括:
- Node:计算节点的抽象，用来描述计算节点的资源抽象、健康状态等
- [[Namespace]]:资源隔离的基本单位，可以简单理解为文件系统中的目录结构
- Pod:用来描述应用实例，包括镜像地址、资源需求等。Kubernetes 中最核心的对象，也是打通应用和基础架构的秘密武器
- Service:服务如何将应用发布成服务，本质上是负载均衡和域名服务的声明
## [[etcd]]
etcd 是 CoreOs 基于 Raft 开发的分布式 key-value 存储，可用于服务发现、共享配置以及一致性保障(如数据库选主、分布式锁等)。
- 基本的 key-value 存储;
- 监听机制;
- key 的过期及续约机制，用于监控和服务发现;
- 原子 CAS 和 CAD，用于分布式锁和 leader 选举,
## APIServer
Kube-APIServer是Kubernetes 最重要的核心组件之一，主要提供以下功能：
- 提供集群管理的 REST API接口，包括:
	- 认证 Authentication;
	- 授权 Authorization;
	- 准入Admission(Mutating & Valiating)。
-  提供其他模块之间的数据交互和通信的枢纽(其他模块通过 APIServer 查询或修改数据，只有 APIServer 才直接操作 etcd)。
- APIServer 提供 etcd 数据缓存以减少集群对 etcd 的访问。
![[APIServer展开.png]]
## Controller Manager
- Controller Manager 是集群的大脑，是确保整个集群动起来的关键
- 作用是确保 Kubernetes 遵循声明式系统规范，确保系统的真实状态(Actual State)与用户定义的期望状态(Desired State)一致;
- Controller Manager 是多个控制器的组合，每个Controler 事实上都是一个 controlloop，负责侦听其管控的对象，当对象发生变更时完成配置;
- Controller 配置失败通常会触发自动重试，整个集群会在控制器不断重试的机制下确保最终一致性( Eventual Consistency)。
