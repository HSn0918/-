#kafka 
# Kafka Broker端配置参数

## 存储配置

### log.dirs
**描述**：指定Broker使用的多个文件目录路径。这个参数没有默认值，必须手动指定。  
**设置建议**：只需设置`log.dirs`，不要设置`log.dir`。在生产环境中，最好配置多个路径，格式为CSV，如`/home/kafka1,/home/kafka2,/home/kafka3`。这些目录应尽可能挂载到不同的物理磁盘上。  
====好处====：提升读写性能：多块磁盘同时读写数据可提高吞吐量。实现故障转移：Kafka 1.1引入的功能，损坏的磁盘数据会自动转移到其他正常磁盘上，Broker仍能正常工作。

## ZooKeeper相关参数

### zookeeper.connect
**描述**：指定ZooKeeper连接地址，格式为CSV，如`zk1:2181,zk2:2181,zk3:2181`。  
**设置建议**：多个Kafka集群使用同一套ZooKeeper集群时，使用chroot，如`zk1:2181,zk2:2181,zk3:2181/kafka1`和`zk1:2181,zk2:2181,zk3:2181/kafka2`。chroot只需在最后加一次。

## Broker连接参数

### listeners
**描述**：指定外部连接Kafka服务的协议、主机名和端口号的三元组列表。  
**格式**：`<协议名称, 主机名, 端口号>`，如`PLAINTEXT://localhost:9092`。

### advertised.listeners
**描述**：Broker对外发布的监听器配置。

### listener.security.protocol.map
**描述**：指定自定义协议底层使用的安全协议。  
**示例**：`listener.security.protocol.map=CONTROLLER:PLAINTEXT`。

### host.name/port
**描述**：过期参数，不要设置。  
**建议**：主机名配置中最好全部使用主机名，而非IP地址，以避免连接问题。

## Topic管理参数

### auto.create.topics.enable
**描述**：是否允许自动创建Topic。  
**建议**：设置为`false`，避免自动创建无用Topic。  
====原因====：在生产环境中，有些名字稀奇古怪的Topic往往是因为拼写错误导致的自动创建，设置为false可以防止这种情况。

### unclean.leader.election.enable
**描述**：是否允许不干净的Leader选举。  
**建议**：设置为`false`，避免数据丢失。  
====原因====：未同步完全的副本成为Leader可能导致数据丢失，关闭该功能可以避免这种情况。

### auto.leader.rebalance.enable
**描述**：是否允许定期进行Leader重新选举。  
**建议**：设置为`true`，以提高Leader的可靠性和性能。  
====原因====：定期重新选举Leader可以平衡负载，提升系统整体性能。

## 数据留存参数

### log.retention.{hours|minutes|ms}
**描述**：控制消息数据的保存时间。优先级从高到低为`ms`、`minutes`、`hours`。 
**示例**：`log.retention.hours=168`表示保存7天的数据。  
====原因====：通常设置hours级别，可以根据业务需求灵活调整数据保存时间。

### log.retention.bytes
**描述**：指定Broker为消息保存的总磁盘容量大小。  
**建议**：默认值为`-1`（不限制）。在云上多租户环境中，需要限制每个租户的磁盘空间。  
====原因====：防止单个租户过度占用磁盘空间，影响其他租户的使用。

### message.max.bytes
**描述**：控制Broker接收的最大消息大小。  
**建议**：设置一个较大的值（大于默认的1000012），以处理大消息。  
====原因====：实际场景中，大于1MB的消息并不少见，设置较大的值可以提高系统的灵活性。

## Topic级别参数

### 保存消息的参数

- **retention.ms**：规定了该Topic消息被保存的时长。默认是7天，即该Topic只保存最近7天的消息。一旦设置了这个值，它会覆盖掉Broker端的全局参数值。
- **retention.bytes**：规定了要为该Topic预留多大的磁盘空间。和全局参数作用相似，这个值通常在多租户的Kafka集群中会有用武之地。当前默认值是-1，表示可以无限使用磁盘空间。

### 消息大小的参数

- **max.message.bytes**：决定了Kafka Broker能够正常接收该Topic的最大消息大小。如果在全局层面上不好给出一个合适的最大消息值，不同业务部门能够自行设定这个Topic级别参数就显得非常必要。在实际场景中，这种用法也确实是非常常见的。

### 设置Topic级别参数的方法

可以通过两种方式设置Topic级别参数：

1. **创建Topic时设置**
2. **修改Topic时设置**

#### 创建Topic时设置

假设你的部门需要将交易数据发送到Kafka进行处理，需要保存最近半年的交易数据，同时这些数据很大，通常都有几MB，但一般不会超过5MB。可以用以下命令来创建Topic：

```sh
bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic transaction --partitions 1 --replication-factor 1 --config retention.ms=15552000000 --config max.message.bytes=5242880
```

#### 修改Topic时设置

假设现在需要发送最大值是10MB的消息，可以用以下命令修改：

```sh
bin/kafka-configs.sh --zookeeper localhost:2181 --entity-type topics --entity-name transaction --alter --add-config max.message.bytes=10485760
```

总体来说，你只能使用这两种方式来设置Topic级别参数。建议始终坚持使用第二种方式来设置，因为未来Kafka社区很有可能统一使用kafka-configs脚本来调整Topic级别参数。

## JVM参数

Kafka服务器端代码是用Scala语言编写的，但终归还是编译成Class文件在JVM上运行，因此JVM参数设置对于Kafka集群的重要性不言而喻。

### Java版本

极其不推荐将Kafka运行在Java 6或7的环境上。Kafka自2.0.0版本开始，已经正式摒弃对Java 7的支持，至少使用Java 8。

### 堆大小设置

堆大小参数至关重要。建议将JVM堆大小设置成6GB，这是目前业界比较公认的一个合理值。默认的1GB有点小，毕竟Kafka Broker在与客户端进行交互时会在JVM堆上创建大量的ByteBuffer实例，Heap Size不能太小。

### 垃圾回收器设置

垃圾回收器的设置也是非常重要的参数。如果在使用Java 7，可以根据以下法则选择合适的垃圾回收器：

- 如果Broker所在机器的CPU资源非常充裕，建议使用CMS收集器。启用方法是指定`-XX:+UseCurrentMarkSweepGC`。
- 否则，使用吞吐量收集器。开启方法是指定`-XX:+UseParallelGC`。

如果在使用Java 8，可以手动设置使用G1收集器。在没有任何调优的情况下，G1表现得要比CMS出色，主要体现在更少的Full GC，需要调整的参数更少等，所以使用G1就好了。

### JVM参数设置方法

可以通过设置以下两个环境变量来为Kafka进行设置：

- **KAFKA_HEAP_OPTS**：指定堆大小。
- **KAFKA_JVM_PERFORMANCE_OPTS**：指定GC参数。

比如可以这样启动Kafka Broker：

```sh
$> export KAFKA_HEAP_OPTS=--Xms6g  --Xmx6g
$> export KAFKA_JVM_PERFORMANCE_OPTS= -server -XX:+UseG1GC -XX:MaxGCPauseMillis=20 -XX:InitiatingHeapOccupancyPercent=35 -XX:+ExplicitGCInvokesConcurrent -Djava.awt.headless=true
$> bin/kafka-server-start.sh config/server.properties
```

## 操作系统参数

Kafka集群通常需要设置以下操作系统参数：

### 文件描述符限制

任何一个Java项目最好都调整下这个值。通常情况下将它设置成一个超大的值是合理的做法，比如`ulimit -n 1000000`。

### 文件系统类型

选择性能较好的文件系统如XFS。根据官网的测试报告，XFS的性能要强于ext4，所以生产环境最好还是使用XFS。

### Swap调优

建议将`swappiness`配置成一个接近0但不为0的值，比如1。

### 提交时间

默认是5秒，可以适当地增加提交间隔来降低物理磁盘的写操作。

通过以上几个方面的设置和调整，可以有效提升Kafka集群的性能和可靠性。